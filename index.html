<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body{
            moz-user-select: -moz-none; 
            -moz-user-select: none; 
            -o-user-select:none; 
            -khtml-user-select:none; 
            -webkit-user-select:none; 
            -ms-user-select:none; 
            user-select:none;
        }
    </style>
    <script>
        let startMove=false;
        let boxX=0;
        let boxY=0;
        let startX=0;
        let startY=0;
        let lastObj=null;
        function move(obj){
            //检测当前移动的元素是否为点击选中的元素
            if(lastObj!=obj){
                reset();
            }
            if(startMove){
                var e = event || window.event;
                let box=obj.getBBox();
                
                obj.setAttribute("x", boxX+(e.screenX-startX));
                obj.setAttribute("y", boxY+(e.screenY-startY));
            }
        }
        //释放鼠标，清空状态
        function up(){
            reset();
            var e = event || window.event;
        }
        function reset(){
            startMove=false;
            startX=0;
            startY=0;
        }
        //鼠标按下记录当前坐标
        function down(obj){
            var e = event || window.event;
            lastObj=obj;
            startMove=true;
            let box=obj.getBBox();
            startX=e.screenX;
            startY=e.screenY;
            boxX=parseInt(obj.getAttribute("x"));
            boxY=parseInt(obj.getAttribute("y"));

            if(checkSelect()){
                let txt=document.getElementById("txt");
                txt.value=obj.textContent;
                // console.log(txt);
                // console.log(currentObj.textContent);
            }
        }
        function getTextValue(){
            if(!checkSelect()){
                return;
            }
            let txt=document.getElementById("txt");
            txt.value=currentObj.textContent;
        }
        function changeText(){
            if(!checkSelect()){
                return;
            }
            let txt=document.getElementById("txt");
            let color=document.getElementById("color");
            currentObj.textContent=txt.value;
            currentObj.setAttribute("style", "fill:"+color.value );
        }
        function fileChange(obj){
            let src=window.URL.createObjectURL(obj.files[0]);
            let acceptTypes=obj.accept.split(',');
            let isAcceptType=false;
            acceptTypes.forEach(i=>{
                if(obj.files[0].type==i){
                    isAcceptType=true;
                }
                // else{
                //     console.log(i+","+obj.files[0].type);
                // }
            });
            if(!isAcceptType){
                showErr("不支持的类型")
                return;
            }
            // console.log(obj);
            createImage(src);
            drawSVG();
        }
        function showErr(txt){
            let err=document.getElementById("errTxt");
            err.textContent=txt;
        }
        function addText(){
            let txt=document.getElementById("txt");
            createText(txt.value,0,10);
            drawSVG();
        }
        //调整文字颜色
        function changeColor(){
            if(!checkSelect()){
                return;
            }
            if(currentObj.textContent!=""){
                let color=document.getElementById("color");
                currentObj.setAttribute("style", "fill:"+color.value );
            }
        }
        //清除颜色
        function clearColor(){
            if(checkSelect()){
                currentObj.setAttribute("style", "fill:black");
            }
        }
        //每次点击的对象
        let currentObj=null;
        let currentID=null;
        function setCurrentObj(obj){
            currentObj=obj;
            currentID=obj.id;
        }
        //删除
        function del(){
            // if(currentObj!=null){
            //     currentObj.remove();
            //     currentObj=null;
            // }
            if(currentID!=null){
                objList.delete(currentID);
                currentObj=null;
                currentID=null;
                drawSVG();
            }
        }
        function save(){
            let obj=document.getElementById("svgObj");
            let img=document.getElementById("textImg");
            var data = 'data:image/svg+xml;base64,'+ window.btoa(unescape(encodeURIComponent(obj.outerHTML)));
            console.log(data);
            // img.Width=100;
            // img.Height=100;
            img.src=data;

            // var canvas = document.createElement('canvas');
			// 	canvas.width = img.width;
			// 	canvas.height = img.height;
			// 	var ctx = canvas.getContext('2d');
			// 	ctx.drawImage(img, 0, 0);
			// 	setTimeout(function() {
			// 		var data = canvas.toDataURL('image/png');
			// 		var a = document.createElement('a');
			// 		a.href = data;  //将画布内的信息导出为png图片数据
			// 		a.download = "logo.png";  //设定下载名称
            //         a.type="image/png";
			// 		a.click(); //点击触发下载
			// 	}, 1000);
        }
        //保存所有的对象
        let objList=new Map();
        let imgPatternList=[];
        const SVGNS="http://www.w3.org/2000/svg";
        //创建图片对象
        function createImage(src){
            let img=document.createElementNS(SVGNS,"image");
            img.setAttribute("width","1");
            img.setAttribute("height","1");
            img.href.baseVal = src;// img.setAttribute("xlink.href",src);
            let pattern=document.createElementNS(SVGNS,"pattern");
            pattern.setAttribute("width","100%");
            pattern.setAttribute("height","100%");
            pattern.setAttribute("patternContentUnits","objectBoundingBox");
            pattern.appendChild(img);
            let randomID=Math.random().toString(36).slice(2);
            pattern.id=randomID;
            imgPatternList.push(pattern);


            let rect=document.createElementNS(SVGNS,"rect");
            rect.setAttribute("onmousedown","down(this)");
            rect.setAttribute("onmousemove","move(this)");
            rect.setAttribute("onclick","setCurrentObj(this)");
            rect.setAttribute("x","0");
            rect.setAttribute("y","0");
            rect.setAttribute("rx","0");
            rect.setAttribute("ry","0");
            rect.setAttribute("width","100");
            rect.setAttribute("height","100");
            rect.setAttribute("fill","url(#"+randomID+")");
            rect.id=getRandomID();

            let svg=document.getElementById("svgObj");
            svg.appendChild(pattern);
            // svg.appendChild(rect);
            objList.set(rect.id,rect);
        }
        //创建文字
        function createText(txt,x,y){
            let text=document.createElementNS(SVGNS,"text");
            text.setAttribute("onmousedown","down(this)");
            text.setAttribute("onmousemove","move(this)");
            text.setAttribute("onclick","setCurrentObj(this)");
            text.setAttribute("x",x);
            text.setAttribute("y",y);
            text.setAttribute("fill","black");
            text.textContent=txt;
            text.id=getRandomID();

            let svg=document.getElementById("svgObj");
            // console.log(text.outerHTML);
            // svg.appendChild(text);
            objList.set(text.id,text);
        }
        
        function getRandomID(){
            return objList.size.toString()+Math.random().toString(36).slice(2);
        }

        function testSvgData(){
            createImage("img.jpg");
            createImage("img.jpg");
            createText("hello",0,10);
            createText("hello",0,50);
            drawSVG();
        }
        function addSvgItem(){
            let svg=document.getElementById("svgObj");
            svg.appendChild();
        }
        function drawSVG(){
            let svg=document.getElementById("svgObj");
            svg.innerHTML="";
            for(let key in imgPatternList){
                svg.appendChild(imgPatternList[key]);
            }
            // console.log(objList);
            objList.forEach(i=>{
                // console.log(i)
                svg.appendChild(i);
            });         
        }
        function checkSelect(){
            if(currentID==null){
                return false;
            }
            return true;
        }
        //上移一层
        function moveBehind(){
            if(!checkSelect()){
                return;
            }
            //找到了需要调整的对象
            let getItem=false;
            let tmpMap=new Map();
            let lastData=null;
            
            objList.forEach(i => {
                if(getItem){
                    tmpMap.set(i.id,i);
                    tmpMap.set(lastData.id,lastData);
                    getItem=false;
                }
                else{
                    if(i.id==currentID){
                        lastData=i;
                        getItem=true;
                    }
                    else{
                        tmpMap.set(i.id,i);
                    }
                }
                
                lastData=i;
            });
            objList=tmpMap;
            drawSVG();
        }
        //下移一层
        function moveFront(){
            if(!checkSelect()){
                return;
            }
            let checkFirst=false;
            let tmpMap=new Map();
            let lastData=null;

            try{
                objList.forEach(i=>{
                    if(!checkFirst){                    
                        //已经在最上级
                        if(i.id==currentID){
                            throw "";
                        }
                        console.log("d");
                        checkFirst=true;
                    }
                    //循环到需要移动的元素
                    //调整位置
                    console.log(i.id);
                    console.log(currentID);
                    if(i.id==currentID){
                        tmpMap.delete(lastData.id);
                        tmpMap.set(i.id,i);
                        tmpMap.set(lastData.id,lastData);
                    }
                    else{
                        tmpMap.set(i.id,i);
                    }
                    lastData=i;
                });
                objList=tmpMap;
                drawSVG();
            }
            catch(e){

            }
        }
        //移动到最上层
        function moveTopLevel(){
            if(!checkSelect()){
                return;
            }
            let tmp=objList.get(currentID);
            objList.delete(currentID);
            objList.set(currentID,tmp);
            drawSVG();
        }
        //移动到最底层
        function moveLowestLevel(){
            if(!checkSelect()){
                return;
            }
            let tmp=objList.get(currentID);
            objList.delete(currentID);
            let tmpMap=new Map();
            tmpMap.set(currentID,tmp);
            objList.forEach(i=>{
                tmpMap.set(i.id,i);
            });
            objList=tmpMap;
            drawSVG();
        }
    </script>
</head>
<body>
    <svg id="svgObj" onmouseup="up()" style="border:1px solid #c3c3c3;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve">
        <!-- <pattern  id="avatar" width="100%" height="100%" patternContentUnits="objectBoundingBox">
            <image width="1" height="1" xlink:href="img.jpg"/>
        </pattern> -->
        <!-- <text onmousedown="down(this)" onmousemove="move(this)" onclick="setCurrentObj(this)"
        id="svgText" x="10" y="50" fill="#ccc">I love SVG</text> -->
        <!-- <rect onmousedown="down(this)" onmousemove="move(this)"  onclick="setCurrentObj(this)"
        id="test1" x="0" y="80" rx="0" ry="0" width="100" height="100" fill="url(#avatar)"/> -->
    </svg>
    <br/>
    <img id="textImg" width="200px" height="100px"/>
    <!-- <img id="forsvg" width="300" height="150" src='data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"><foreignObject width="120" height="50"><body xmlns="http://www.w3.org/1999/xhtml"><p style="font-size:12px;margin:0;">一段需要word wrap的文字。</p></body></foreignObject></svg>'> -->
    <label id="errTxt" style="color:red;font-size: 12px"></label>
    <br/>
    文字颜色:<input type="color" id="color" onchange="changeColor()"/>
    <input type="button" value="清除颜色" onclick="clearColor()"/>
    <input type="file" id="file" onchange="fileChange(this)" accept="image/jpg,image/jpeg,image/png,image/PNG"/>
    <br/>
    输入文字:<input type="text" id="txt" onchange="changeText()"/>
    <input type="button" value="输入完成"/><input type="button" onclick="addText()" value="新增文字"/><br/>
    <input type="button" value="移动到上一层" onclick="moveBehind()"/>
    <input type="button" value="移动到下一层" onclick="moveFront()"/>
    <input type="button" value="移动到最上层" onclick="moveTopLevel()"/>
    <input type="button" value="移动到最底层" onclick="moveLowestLevel()"/>
    <input type="button" value="调整大小" onclick="changePos()"/>
    <input type="button" value="删除" onclick="del()"/>
    <input type="button" value="save" onclick="save()"/>
    <script>
        testSvgData();
    </script>
</body>
</html>